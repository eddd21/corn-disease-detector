<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Detector de Enfermedades</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-success shadow">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-leaf me-2"></i>
                Detector de Enfermedades en Maíz
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-arrow-left me-1"></i> Volver al Inicio
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-center">
                    <i class="fas fa-chart-line me-2"></i>Dashboard de Análisis
                </h2>
                <p class="text-center text-muted">Estadísticas y métricas del sistema</p>
            </div>
        </div>

        <!-- Tarjetas de Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <i class="fas fa-images fa-2x mb-2"></i>
                        <h3 id="totalAnalyses">0</h3>
                        <p>Total de Análisis</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <i class="fas fa-heart fa-2x mb-2"></i>
                        <h3 id="healthyCount">0</h3>
                        <p>Plantas Saludables</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h3 id="diseaseCount">0</h3>
                        <p>Enfermedades Detectadas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <i class="fas fa-percentage fa-2x mb-2"></i>
                        <h3 id="avgConfidence">0%</h3>
                        <p>Confianza Promedio</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row">
            <div class="col-md-8 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Distribución de Enfermedades</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="diseaseChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card shadow">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Enfermedades Más Comunes</h5>
                    </div>
                    <div class="card-body">
                        <div id="commonDiseases"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del Sistema -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Información del Sistema
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Características Técnicas</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success me-2"></i>Análisis con Visión por Computadora</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Detección de 5 enfermedades diferentes</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Procesamiento en tiempo real</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Base de datos local SQLite</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Enfermedades Detectadas</h6>
                                <ul class="list-unstyled">
                                    <li><span class="badge bg-success me-2">✓</span>Saludable</li>
                                    <li><span class="badge bg-danger me-2">✓</span>Tizón de la Hoja</li>
                                    <li><span class="badge bg-warning me-2">✓</span>Roya Común</li>
                                    <li><span class="badge bg-warning me-2">✓</span>Mancha Gris</li>
                                    <li><span class="badge bg-danger me-2">✓</span>Carbón de la Espiga</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Cargar datos del dashboard
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/history?limit=100');
                const data = await response.json();
                updateDashboard(data.history);
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function updateDashboard(analyses) {
            // Estadísticas básicas
            document.getElementById('totalAnalyses').textContent = analyses.length;
            
            const healthy = analyses.filter(a => a.prediction === 'Saludable').length;
            const diseases = analyses.length - healthy;
            
            document.getElementById('healthyCount').textContent = healthy;
            document.getElementById('diseaseCount').textContent = diseases;
            
            // Confianza promedio
            const avgConfidence = analyses.length > 0 
                ? analyses.reduce((sum, a) => sum + a.confidence, 0) / analyses.length 
                : 0;
            document.getElementById('avgConfidence').textContent = 
                Math.round(avgConfidence * 100) + '%';

            // Gráfico de distribución
            updateDiseaseChart(analyses);
            updateCommonDiseases(analyses);
        }

        function updateDiseaseChart(analyses) {
            const ctx = document.getElementById('diseaseChart').getContext('2d');
            
            // Contar por enfermedad
            const diseaseCounts = {};
            analyses.forEach(analysis => {
                diseaseCounts[analysis.prediction] = (diseaseCounts[analysis.prediction] || 0) + 1;
            });

            const labels = Object.keys(diseaseCounts);
            const data = Object.values(diseaseCounts);
            const colors = labels.map(label => {
                const colorMap = {
                    'Saludable': '#28a745',
                    'Tizón de la Hoja': '#dc3545',
                    'Roya Común': '#ffc107',
                    'Mancha Gris': '#fd7e14',
                    'Carbón de la Espiga': '#6f42c1'
                };
                return colorMap[label] || '#6c757d';
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Número de Casos',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('0.6', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCommonDiseases(analyses) {
            const container = document.getElementById('commonDiseases');
            
            // Contar enfermedades
            const diseaseCounts = {};
            analyses.forEach(analysis => {
                if (analysis.prediction !== 'Saludable') {
                    diseaseCounts[analysis.prediction] = (diseaseCounts[analysis.prediction] || 0) + 1;
                }
            });

            const sortedDiseases = Object.entries(diseaseCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (sortedDiseases.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No hay enfermedades registradas</p>';
                return;
            }

            container.innerHTML = sortedDiseases.map(([disease, count]) => `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <span>${disease}</span>
                    <span class="badge bg-primary">${count}</span>
                </div>
            `).join('');
        }

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', loadDashboardData);
    </script>
</body>
</html>